<html>

<head>
    <script src="./vue.js"></script>
</head>

<body>
    <div id="app">
        <P>
            <label for="host_list">PLC地址</label>
            <select name="host_list" id="host_list" v-model="ip" @change="changeWS">
                <option v-for="host in host_list" :value="host.id">{{host.name}}</option>
            </select><span>IP:{{ip}}</span>
            <span>通信状态：{{wsstate}}</span>
        </P>
        <p>
            <label for="DBName">数据块符号</label>
            <input type="text" id="DBName" v-model="DBName" />
        </p>
        <label for="DBTags">数据块内部变量</label>
        <ul id="DBTags">
            <li v-for="item in goonode">
                <label :for="item.name">{{item.name}}</label>
                <span :id="item.name">{{item.value}}</span>
                <input type="text" :id="'input'+item.name" v-model="item.newValue" v-show="item.is_changing" />
                <button @click="prechange(item)" v-show="!item.is_changing">修改</button>
                <button @click="change(item)" v-show="item.is_changing">完成</button>
            </li>
        </ul>
    </div>
</body>
<script type="text/javascript">
    function sub_ws_var(ws, item) {
        name = `${vm.DBName}/${item.name}`;
        ws.send(JSON.stringify({
            action: "subscribe",
            name,
        }));
    }

    function get_ws_var(ws, item) {
        name = `${vm.DBName}/${item.name}`;
        ws.send(JSON.stringify({
            action: "read",
            name,
        }));
    }

    function set_ws_var(ws, item) {
        const name = `${vm.DBName}/${item.name}`;
        const value = Number(item.newValue);
        ws.send(JSON.stringify({
            action: "write",
            name,
            value
        }));
    }

    const goonode = Object.entries({
        nodeID: 0,
        workOK: false,
        commOK: false,
        pump_run_1: false,
        pump_run_2: false,
        pump_run_3: false,
        pump_run_4: false,
        pump_run_5: false,
        temperature: 0.0,
        pressure: 0.0,
        flow: 0.0,
    }).map(([name, value]) => ({
        name,
        value,
        is_changing: false,
        newValue: value,
    }));
    let ws;
    let ip = '';

    const vm = new Vue({
        el: '#app',
        data: {
            host_list: [{
                    name: "本机",
                    id: "127.0.0.1:8080"
                },
                {
                    name: "孤岛孤永出口",
                    id: "192.168.37.18:8078"
                },
                {
                    name: "永安孤永入口",
                    id: "192.168.38.17:8087"
                },
                {
                    name: "永安孤永出口",
                    id: "192.168.38.11:8081"
                },
                {
                    name: "东营孤永入口",
                    id: "192.168.31.18:8018"
                },
                {
                    name: "孤岛孤罗出口",
                    id: "192.168.37.19:8079"
                },
                {
                    name: "集贤孤罗入口",
                    id: "192.168.39.17:8097"
                },
                {
                    name: "集贤孤罗出口",
                    id: "192.168.39.11:8091"
                },
                {
                    name: "东营孤罗入口",
                    id: "192.168.31.19:8019"
                },
            ],
            ip,
            DBName: "nodeGD8",
            ws_state_id: -1,
            goonode,
        },
        created() {
            this.ip = this.host_list[0].id;
            this.changeWS();
        },
        methods: {
            prechange: (item) => {
                item.is_changing = true;
            },
            change: (item) => {
                set_ws_var(ws, item);
                item.is_changing = false;
            },
            changeWS() {
                ws?.close();
                ws = new WebSocket(`ws://${this.ip}`);
                this.DBName = "nodeGD8";

                ws.onopen = evt => {
                    console.log("Connection open ...");
                    for (const item of this.goonode) {
                        sub_ws_var(ws, item);
                    };
                    this.ws_state_id = ws.readyState;
                };

                ws.onmessage = evt => {
                    console.log("Received Message: " + evt.data);
                    let ret = JSON.parse(evt.data);
                    if (ret?.error) return;
                    for (const item of this.goonode) {
                        if (item.name == ret.name.replace(`${this.DBName}/`, "")) {
                            item.value = item.newValue = ret.value;
                            return;
                        }
                    }
                };

                ws.onclose = evt => {
                    console.log("Connection closed.");
                    this.ws_state_id = ws.readyState;
                };
            }
        },
        computed: {
            wsstate() {
                switch (this.ws_state_id) {
                    case -1:
                        return "未初始化";
                    case ws.CONNECTING:
                        return "正在连接";
                    case ws.CLOSING:
                        return "正在关闭";
                    case ws.CLOSED:
                        return "已关闭";
                    case ws.OPEN:
                        return "已打开";
                    default:
                        return "未初始化";
                }
            },
        }
    })
</script>

</html>